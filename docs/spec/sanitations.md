_Author_:  @niveathika \
_Created_: 14/06/2025 \
_Updated_: 06/07/2025 \
_Edition_: Swan Lake

# Sanitation for OpenAPI specification

This document outlines the modifications and enhancements made to the OpenAPI specification for `salesforce.marketingcloud`.
Since there is no official OpenAPI specification, the spec was generated by converting the [Salesforce Marketing Cloud Postman Collection](https://www.postman.com/salesforce-developers/salesforce-developers/folder/hs55w6u/rest). While the Postman collection provided a solid foundation, it lacked many parameters and response structures. These gaps were filled by manually adding the required details and making further adjustments to improve usability and address language-specific limitations.

**Note:** Only a subset of APIs was implemented, as adding all parameter and response types required significant manual effort.

### Sanitation Steps Applied

1. Added the `OAuth2` credential security schema.
2. Retained only the endpoints selected for implementation.
3. Removed authentication endpoints.
4. Removed discovery endpoints.
5. Added parameters and response structures, keeping only the minimum required fields with `additionalProperties` set to true.
6. Ran `bal openapi align` and `bal openapi flatten` commands.
7. Added `operationId` for all paths.

## Adding New APIs

To add a new API to the specification and client:

1. Locate the relevant API documentation page in the [SFMC documentation](https://developer.salesforce.com/docs/marketing/marketing-cloud/guide/apis-overview.html).
2. Add the endpoint and related schemas to the `docs/spec/openapi.json` file.
   > **Tip:** Review both the Guides and Reference pages, as Guides often contain additional details not present in the Reference examples.
3. Generate the client using the command in the [OpenAPI CLI Command](#openapi-cli-command) section.
4. Apply the sanitations described in [Sanitation for Generated Client](#sanitation-for-generated-client).

## OpenAPI CLI Command

Use the following command to generate the Ballerina client from the OpenAPI specification. Run this from the repository root:

```bash
bal openapi -i docs/spec/openapi.json -o ballerina --mode client --client-methods remote --license docs/license.txt
```
Note: The license year is hardcoded to 2025, change if necessary.

## Sanitation for Generated Client

The following changes were made to the generated client to support multi-tenancy and improve usability for Marketing Cloud APIs:

1. Replaced `serviceUrl` with `subDomain`:
   The serviceUrl client parameter was removed and replaced with a required subDomain parameter to better represent tenant-specific endpoints.
   ```ballerina
   // Before
   public isolated function init(ConnectionConfig config, string serviceUrl = "https://{{et_subdomain}}.rest.marketingcloudapis.com") returns error? {
   // After
   public isolated function init(string subDomain, ConnectionConfig config) returns error? {
   ```

2. Dynamic URL Construction:
   The `serviceUrl` and `auth` values are now dynamically constructed within the `init` method using the provided `subDomain`.
   ```ballerina
   // Before
   http:ClientConfiguration httpClientConfig = {auth: config.auth, ...};
   // After
   string serviceUrl = string `https://${subDomain}.rest.marketingcloudapis.com`;
   http:ClientConfiguration httpClientConfig = {auth: getUpdatedAuthConfig(config.auth, subDomain), ...};
   ```

3. Enhanced Auth Config:
   The authentication configuration in `types.bal` (`OAuth2ClientCredentialsGrantConfig`) was updated to allow overriding the `credentialBearer` property, enabling tenant-specific credential management.
   ```ballerina
   // Before
   public type OAuth2ClientCredentialsGrantConfig record {| 
      *http:OAuth2ClientCredentialsGrantConfig;
      # Token URL
      string tokenUrl = "https://{{et_subdomain}}.auth.marketingcloudapis.com/v2/token";
   |};

   // After
   public type OAuth2ClientCredentialsGrantConfig record {| 
      *http:OAuth2ClientCredentialsGrantConfig;
      # Credential Bearer type to use for the request
      oauth2:CredentialBearer credentialBearer = oauth2:POST_BODY_BEARER;
      # Token Url
      string tokenUrl = "";
      # The member ID (MID) of your Marketing Cloud account
      string accountId?;
   |};
   ```

4. Utility Functions:
   Introduced a new `utils_additional.bal` file for supplementary utility functions.
